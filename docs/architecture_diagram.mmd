graph TD
    %% Nodes
    User([User Browser])
    
    subgraph GKE_Cluster["Google Kubernetes Engine (agiles-cluster)"]
        Flask[("Python Flask App\n(Monolithic Container)")]
    end
    
    subgraph GCP_Services["Google Cloud Platform Services"]
        GCS[("Google Cloud Storage\n(Bucket: agiles-video-upload)")]
        Vertex[("Vertex AI\n(Model: gemini-2.5-flash)")]
    end

    %% Synchronous Upload Flow (Solid Lines)
    User -- "1. POST /upload\n(multipart/form-data: video.mp4)" --> Flask
    Flask -- "2. Write Object\n(gs://agiles-video-upload/<uuid>/video.mp4)" --> GCS
    Flask -- "3. GenerateContent Request\n(Prompt + GCS URI)" --> Vertex
    Vertex -- "4. Response\n(JSON: Title, Synopsis, Timestamps)" --> Flask
    Flask -- "5. Write Objects\n(metadata.json, thumbnail.jpg)" --> GCS
    Flask -- "6. Redirect /video/<uuid>\n(HTML Page)" --> User

    %% Library/Read Flow (Dotted Lines)
    User -. "7. GET /library" .-> Flask
    Flask -. "8. List Objects\n(prefix=*, suffix=metadata.json)" .-> GCS
    GCS -. "9. Return Object Metadata" .-> Flask
    Flask -. "10. Render Library View\n(HTML List)" .-> User

    %% Styling
    classDef gcp fill:#e8f5e9,stroke:#2e7d32,stroke-width:2px;
    classDef app fill:#e3f2fd,stroke:#1565c0,stroke-width:2px;
    classDef client fill:#fff3e0,stroke:#ef6c00,stroke-width:2px;
    
    class GCS,Vertex gcp;
    class Flask app;
    class User client;